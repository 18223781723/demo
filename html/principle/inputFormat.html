<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <input type="text" id="input" value="">

    <script>
        // 获取dom
        const inputDom = document.getElementById('input');
        let separator = ',';
        let reg = new RegExp(separator, 'g');

        let lastValue = inputDom.value;

        // 监听input事件
        inputDom.addEventListener('input', function (e) {
            let value = inputDom.value;
            // 直接输入小数点
            if (value === '.') {
                inputDom.value = '';
                return;
            }
            let cursorPosition = inputDom.selectionStart;
            // 如果已经有小数点了，继续输入小数点
            if (value.indexOf('.') !== value.lastIndexOf('.') || e.data === separator) {
                let leftOfCursor = value.substring(0, cursorPosition - 1);
                let rightOfCursor = value.substring(cursorPosition);
                inputDom.value = leftOfCursor + rightOfCursor;
                inputDom.selectionStart = cursorPosition - 1;
                inputDom.selectionEnd = cursorPosition - 1;
                return;
            } else if (value[value.length - 1] === '.' && value.indexOf('.') === value.lastIndexOf('.')) {
                return;
            }
            let replaceValue = value.replace(reg, '');
            let formatValue = format(replaceValue);
            let formatValueLeft = formatValue.split('.')[0];
            let leftOfPoint = value.split('.')[0];
            if (e.inputType === 'insertText') { // 输入
                if (e.data === '.') {
                    if (formatValueLeft.length > leftOfPoint.length || leftOfPoint[leftOfPoint.length - 1] === separator || cursorPosition === 5) {
                        cursorPosition -= 1;
                    }
                } else {
                    if (formatValue[1] === separator) {
                        cursorPosition += 1;
                    }
                }
            } else if (e.inputType === 'deleteContentForward') { // 按del键
                if (leftOfPoint.length > 3 && !leftOfPoint.includes(separator)) {
                    cursorPosition += 1;
                }
            } else if (e.inputType === 'deleteContentBackward') { // 退格
                if (formatValue.length === 4) {
                    cursorPosition += 1;
                } else if (replaceValue.length % 3 === 0) {
                    // cursorPosition -= 1;
                }
            }
            inputDom.value = formatValue;
            inputDom.selectionStart = cursorPosition;
            inputDom.selectionEnd = cursorPosition;
        });

        // 格式化
        function format(str) {
            let amount = '';
            let leftOfPoint = str; // 小数点左边
            let rightOfPoint = '';  // 小数点右边
            if (str.includes('.')) {
                [leftOfPoint, rightOfPoint] = str.split('.');
            }
            const length = leftOfPoint.length;
            const n = length % 3;
            if (length > 3) {
                for (let i = 0; i < length; i++) {
                    amount += leftOfPoint[i];
                    if (i + 1 === n || i + 1 > n && i + 1 < length && (i + 1 - n) % 3 == 0) {
                        amount += separator;
                    }
                }
            } else {
                amount = leftOfPoint;
            }
            if (rightOfPoint) {
                amount += '.' + rightOfPoint;
            }
            return amount;
        }

    </script>
</body>

</html>